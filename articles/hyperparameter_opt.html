<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="EpiControl">
<title>Bayesian hyperparameter optimisation • EpiControl</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Bayesian hyperparameter optimisation">
<meta property="og:description" content="EpiControl">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">EpiControl</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/control_est_D.html">Epidemic control based-on deaths</a>
    <a class="dropdown-item" href="../articles/epiestim_ebola.html">Ebola example - using EpiEstim for R estimation</a>
    <a class="dropdown-item" href="../articles/hyperparameter_opt.html">Bayesian hyperparameter optimisation</a>
    <a class="dropdown-item" href="../articles/multiple_NPIs.html">COVID-19 control with a larger NPI space</a>
    <a class="dropdown-item" href="../articles/Report9_MPC.html">Optimal control of ICU cases for COVID-19</a>
    <a class="dropdown-item" href="../articles/Report9_threshold_based.html">Threshold-based control of ICU cases for COVID-19</a>
    <a class="dropdown-item" href="../articles/vaccine_variants_MPC.html">COVID-19 Vaccination and new variant</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Bayesian hyperparameter optimisation</h1>
            
      
      
      <div class="d-none name"><code>hyperparameter_opt.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h3>
<p>This vignette demonstrates how to optimise algorithm hyperparameters.
In this example we would like to select the best the optimal projection
horizon and discount factor to get the best performance across the
entire timeframe of the simulation (i.e. over a much longer timeframe
than we use for projections). This approach is common in receding
horizon control.</p>
<p>We would like to find the best strategy to control a COVID-19
outbreak, with policy revisions every 14 days.</p>
</div>
<div class="section level3">
<h3 id="simulation-with-the-initial-parameters">Simulation with the initial parameters<a class="anchor" aria-label="anchor" href="#simulation-with-the-initial-parameters"></a>
</h3>
<p>Load the required libraries:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sandorberegi.github.io/EpiControl/" class="external-link">EpiControl</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.stat.auckland.ac.nz/~yee/VGAM/" class="external-link">VGAM</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/psolymos/pbapply" class="external-link">pbapply</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://zoo.R-Forge.R-project.org/" class="external-link">zoo</a></span><span class="op">)</span>  <span class="co"># For rolling sum operations</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/yanyachen/rBayesianOptimization" class="external-link">rBayesianOptimization</a></span><span class="op">)</span></span></code></pre></div>
<p>Set up the simulation and run it with our initial parameters:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>Initialise the cluster for parallel computing:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cores</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="va">cores</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/RngStream.html" class="external-link">clusterSetRNGStream</a></span><span class="op">(</span><span class="va">cl</span>, iseed <span class="op">=</span> <span class="fl">20250501</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Epi_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  Pathogen <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"COVID-19"</span>, <span class="st">"Ebola"</span><span class="op">)</span>,</span>
<span>  R0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2.2</span>, <span class="fl">2.5</span><span class="op">)</span>,</span>
<span>  gen_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6.5</span>, <span class="fl">15.0</span><span class="op">)</span>,</span>
<span>  gen_time_var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2.1</span>, <span class="fl">2.1</span><span class="op">)</span>,</span>
<span>  CFR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.0132</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>  mortality_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10.0</span>, <span class="fl">10.0</span><span class="op">)</span>,</span>
<span>  mortality_var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.1</span>, <span class="fl">1.1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">Noise_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  repd_mean <span class="op">=</span> <span class="fl">10.5</span>,  <span class="co"># Reporting delay mean</span></span>
<span>  del_disp <span class="op">=</span> <span class="fl">5.0</span>,    <span class="co"># Reporting delay variance</span></span>
<span>  ur_mean <span class="op">=</span> <span class="fl">0.3</span>,     <span class="co"># Under-reporting mean</span></span>
<span>  ur_beta_a <span class="op">=</span> <span class="fl">50.0</span>   <span class="co"># Beta distribution alpha for under-reporting</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">Action_space</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  NPI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"No restrictions"</span>, <span class="st">"Lockdown"</span><span class="op">)</span>,</span>
<span>  R_coeff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.0</span>, <span class="fl">0.3</span><span class="op">)</span>,</span>
<span>  R_beta_a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">5.0</span><span class="op">)</span>,</span>
<span>  cost_of_NPI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">0.15</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">C_target</span> <span class="op">&lt;-</span> <span class="fl">5000</span></span>
<span><span class="va">D_target</span> <span class="op">&lt;-</span> <span class="fl">12</span></span>
<span><span class="va">r_trans_len</span> <span class="op">&lt;-</span> <span class="fl">7</span></span>
<span></span>
<span><span class="va">sim_settings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  ndays <span class="op">=</span> <span class="fl">40</span> <span class="op">*</span> <span class="fl">7</span>, <span class="co">#simulation length</span></span>
<span>  start_day <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  N <span class="op">=</span> <span class="fl">1e7</span>, <span class="co"># population size</span></span>
<span>  I0 <span class="op">=</span> <span class="fl">10</span>, <span class="co"># initial infections</span></span>
<span>  C_target <span class="op">=</span> <span class="va">C_target</span>, <span class="co">#target cases</span></span>
<span>  C_target_pen <span class="op">=</span> <span class="va">C_target</span><span class="op">*</span><span class="fl">1.5</span>, <span class="co">#overshoot penalty threshold</span></span>
<span>  R_target <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span>  D_target <span class="op">=</span> <span class="va">D_target</span>, <span class="co">#one way to get peaks at 400 is to increase this to 15</span></span>
<span>  D_target_pen <span class="op">=</span> <span class="fl">50</span>, <span class="co">#max death</span></span>
<span>  alpha <span class="op">=</span> <span class="fl">1.3</span><span class="op">/</span><span class="va">C_target</span>, <span class="co">#~proportional gain (regulates error in cases) covid</span></span>
<span>  <span class="co">#alpha = 3.25/C_target #~proportional gain (regulates error in cases) ebola</span></span>
<span>  alpha_d <span class="op">=</span> <span class="fl">0</span><span class="op">*</span><span class="fl">1.3</span><span class="op">/</span><span class="va">D_target</span>,</span>
<span>  ovp <span class="op">=</span> <span class="fl">5.0</span>, <span class="co">#overshoot penalty</span></span>
<span>  dovp <span class="op">=</span> <span class="fl">0</span><span class="op">*</span><span class="fl">10.0</span>, <span class="co">#death overshoot penalty</span></span>
<span>  gamma <span class="op">=</span> <span class="fl">0.95</span>, <span class="co">#discounting factor</span></span>
<span>  n_ens <span class="op">=</span> <span class="fl">20L</span>, <span class="co">#MC assembly size for 4</span></span>
<span>  sim_ens <span class="op">=</span> <span class="fl">10L</span>, <span class="co">#assembly size for full simulation</span></span>
<span>  rf <span class="op">=</span> <span class="fl">14L</span>, <span class="co">#days 14</span></span>
<span>  R_est_wind <span class="op">=</span> <span class="fl">5L</span>, <span class="co">#rf-2 #window for R estimation</span></span>
<span>  susceptibles <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  pred_days <span class="op">=</span> <span class="fl">28L</span>,</span>
<span>  r_trans_steep <span class="op">=</span> <span class="fl">1.5</span>,  <span class="co"># Growth rate</span></span>
<span>  r_trans_len <span class="op">=</span> <span class="va">r_trans_len</span>,  <span class="co"># Number of days for the transition</span></span>
<span>  t0 <span class="op">=</span> <span class="va">r_trans_len</span>  <span class="op">/</span> <span class="fl">2</span>, <span class="co"># Midpoint of the transition</span></span>
<span>  pathogen <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  susceptibles <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  delay <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  ur <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  r_dir <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  LD_on <span class="op">=</span> <span class="fl">14</span>, <span class="co">#on threshold</span></span>
<span>  LD_off <span class="op">=</span> <span class="fl">7</span>, <span class="co">#off threshold</span></span>
<span>  v_max_rate <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>  vac_scale <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  vac_start <span class="op">=</span> <span class="fl">370</span>,</span>
<span>  delta_scale <span class="op">=</span> <span class="fl">40</span>,</span>
<span>  delta_start <span class="op">=</span> <span class="fl">550</span>,</span>
<span>  delta_multiplier <span class="op">=</span> <span class="fl">1.75</span>,</span>
<span>  v_protection_delta <span class="op">=</span> <span class="op">(</span><span class="fl">58</span><span class="op">+</span><span class="fl">85</span><span class="op">)</span><span class="op">/</span><span class="fl">200</span>,</span>
<span>  v_protection_alpha <span class="op">=</span> <span class="fl">0.83</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">episettings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  sim_function <span class="op">=</span> <span class="va">Epi_MPC_run_wd</span>,</span>
<span>  reward_function <span class="op">=</span> <span class="va">reward_fun_wd</span>,</span>
<span>  R_estimator <span class="op">=</span> <span class="va">R_epiestim</span>,</span>
<span>  noise_par <span class="op">=</span> <span class="va">Noise_pars</span>,</span>
<span>  epi_par <span class="op">=</span> <span class="va">Epi_pars</span>,</span>
<span>  actions <span class="op">=</span> <span class="va">Action_space</span>,</span>
<span>  sim_settings <span class="op">=</span> <span class="va">sim_settings</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">column_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"days"</span>, <span class="st">"sim_id"</span>, <span class="st">"I"</span>, <span class="st">"Lambda"</span>, <span class="st">"C"</span>, <span class="st">"Lambda_C"</span>, <span class="st">"S"</span>, <span class="st">"Deaths"</span>, <span class="st">"Re"</span>, <span class="st">"Rew"</span>, <span class="st">"Rest"</span>, <span class="st">"R0est"</span>, <span class="st">"policy"</span>, <span class="st">"R_coeff"</span><span class="op">)</span></span>
<span><span class="va">episim_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="op">(</span><span class="va">sim_settings</span><span class="op">$</span><span class="va">ndays</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">column_names</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">episim_data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">column_names</span></span>
<span></span>
<span><span class="va">episim_data</span><span class="op">$</span><span class="va">policy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">sim_settings</span><span class="op">$</span><span class="va">ndays</span><span class="op">)</span></span>
<span><span class="va">episim_data</span><span class="op">$</span><span class="va">days</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">sim_settings</span><span class="op">$</span><span class="va">ndays</span><span class="op">)</span></span>
<span><span class="va">episim_data</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="va">sim_settings</span><span class="op">$</span><span class="va">I0</span>, <span class="va">sim_settings</span><span class="op">$</span><span class="va">I0</span>, <span class="va">Noise_pars</span><span class="op">$</span><span class="va">ur_mean</span> <span class="op">*</span> <span class="va">sim_settings</span><span class="op">$</span><span class="va">I0</span>, <span class="va">Noise_pars</span><span class="op">$</span><span class="va">ur_mean</span> <span class="op">*</span> <span class="va">sim_settings</span><span class="op">$</span><span class="va">I0</span>, <span class="va">sim_settings</span><span class="op">$</span><span class="va">N</span> <span class="op">-</span> <span class="va">sim_settings</span><span class="op">$</span><span class="va">I0</span>, <span class="fl">0</span>, <span class="va">Epi_pars</span><span class="op">[</span><span class="fl">1</span>, <span class="st">"R0"</span><span class="op">]</span>, <span class="va">Epi_pars</span><span class="op">[</span><span class="fl">1</span>, <span class="st">"R0"</span><span class="op">]</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">episim_data_ens</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">sim_settings</span><span class="op">$</span><span class="va">sim_ens</span>, <span class="va">episim_data</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">ii</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">sim_settings</span><span class="op">$</span><span class="va">sim_ens</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">episim_data_ens</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">sim_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">ii</span>, <span class="va">sim_settings</span><span class="op">$</span><span class="va">ndays</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co"># Ensure actions$cost_of_NPI is numeric</span></span>
<span><span class="va">Action_space</span><span class="op">$</span><span class="va">cost_of_NPI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">Action_space</span><span class="op">$</span><span class="va">cost_of_NPI</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Verify numeric parameters in sim_settings</span></span>
<span><span class="va">numeric_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"alpha"</span>, <span class="st">"alpha_d"</span>, <span class="st">"ovp"</span>, <span class="st">"dovp"</span>, <span class="st">"C_target"</span>, <span class="st">"C_target_pen"</span>, <span class="st">"D_target"</span>, <span class="st">"D_target_pen"</span>, <span class="st">"pred_days"</span>, <span class="st">"sim_ens"</span>, <span class="st">"ndays"</span>, <span class="st">"N"</span><span class="op">)</span></span>
<span><span class="va">sim_settings</span><span class="op">[</span><span class="va">numeric_params</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">sim_settings</span><span class="op">[</span><span class="va">numeric_params</span><span class="op">]</span>, <span class="va">as.numeric</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Don't forget to stop the cluster at the end</span></span>
<span></span>
<span><span class="co"># Export required functions and objects to cluster</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterExport</a></span><span class="op">(</span><span class="va">cl</span>, <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterExport</a></span><span class="op">(</span><span class="va">cl</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"reward_fun_wd"</span>, <span class="st">"Epi_pred_wd"</span>, <span class="st">"Epi_MPC_run_wd"</span>, <span class="st">"episim_data_ens"</span>, <span class="st">"episettings"</span>, <span class="st">"Action_space"</span>, <span class="st">"Epi_pars"</span>, <span class="st">"Noise_pars"</span>, <span class="st">"R_estim"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterEvalQ</a></span><span class="op">(</span><span class="va">cl</span>, <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/psolymos/pbapply" class="external-link">pbapply</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.stat.auckland.ac.nz/~yee/VGAM/" class="external-link">VGAM</a></span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;  [1] "VGAM"      "splines"   "stats4"    "pbapply"   "stats"     "graphics" </span></span>
<span><span class="co">#&gt;  [7] "grDevices" "utils"     "datasets"  "methods"   "base"     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt;  [1] "VGAM"      "splines"   "stats4"    "pbapply"   "stats"     "graphics" </span></span>
<span><span class="co">#&gt;  [7] "grDevices" "utils"     "datasets"  "methods"   "base"</span></span>
<span></span>
<span><span class="co"># Add the cluster object to your settings</span></span>
<span><span class="va">episettings</span><span class="op">$</span><span class="va">parallel</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span><span class="va">episettings</span><span class="op">$</span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="va">cl</span></span>
<span></span>
<span><span class="co"># Run the epicontrol function</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epicontrol.html">epicontrol</a></span><span class="op">(</span><span class="va">episim_data_ens</span>, <span class="va">episettings</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt;   |                                                          |                                                  |   0%</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="defining-our-objective-function">Defining our objective function<a class="anchor" aria-label="anchor" href="#defining-our-objective-function"></a>
</h3>
<p>We want to minimise the combined costs of being off target and
implementation of lockdowns. We want to optimise the projection horizon
and discount factor when calculating costs at decision points.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">a</span><span class="op">&lt;-</span> <span class="fl">1.3</span><span class="op">/</span><span class="fl">5000</span></span>
<span></span>
<span><span class="va">objective</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">horizon</span>, <span class="va">discount</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="va">sim_settings</span><span class="op">$</span><span class="va">pred_days</span> <span class="op">&lt;-</span> <span class="va">horizon</span></span>
<span>  <span class="va">sim_settings</span><span class="op">$</span><span class="va">gamma</span> <span class="op">&lt;-</span> <span class="va">discount</span></span>
<span></span>
<span>  <span class="va">episettings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    sim_function <span class="op">=</span> <span class="va">Epi_MPC_run_wd</span>,</span>
<span>    reward_function <span class="op">=</span> <span class="va">reward_fun_wd</span>,</span>
<span>    R_estimator <span class="op">=</span> <span class="va">R_estim</span>,</span>
<span>    noise_par <span class="op">=</span> <span class="va">Noise_pars</span>,</span>
<span>    epi_par <span class="op">=</span> <span class="va">Epi_pars</span>,</span>
<span>    actions <span class="op">=</span> <span class="va">Action_space</span>,</span>
<span>    sim_settings <span class="op">=</span> <span class="va">sim_settings</span>,</span>
<span>    parallel <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epicontrol.html">epicontrol</a></span><span class="op">(</span><span class="va">episim_data_ens</span>, <span class="va">episettings</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">rewards</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">res</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">cases_v</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">C</span></span>
<span>    <span class="va">interventions</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">policy</span></span>
<span></span>
<span>    <span class="co"># single bracket: keeps length matching 'interventions'</span></span>
<span>    <span class="va">interv_costs</span> <span class="op">&lt;-</span> <span class="va">Action_space</span><span class="op">$</span><span class="va">cost_of_NPI</span><span class="op">[</span><span class="va">interventions</span><span class="op">]</span></span>
<span></span>
<span>    <span class="va">case_err</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">cases_v</span> <span class="op">-</span> <span class="va">sim_settings</span><span class="op">$</span><span class="va">C_target</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">rewards</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">-</span><span class="va">a</span> <span class="op">*</span> <span class="va">case_err</span> <span class="op">-</span> <span class="va">interv_costs</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">mean_reward</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">rewards</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>Score <span class="op">=</span> <span class="va">mean_reward</span>,</span>
<span>       Pred <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Let’s do the optimisation:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">OPT_Res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rBayesianOptimization/man/BayesianOptimization.html" class="external-link">BayesianOptimization</a></span><span class="op">(</span><span class="va">objective</span>,</span>
<span>                                bounds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>horizon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">14L</span>, <span class="fl">35L</span><span class="op">)</span>,</span>
<span>                                              discount <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">0.99</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                init_points <span class="op">=</span> <span class="fl">5</span>, n_iter <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                                acq <span class="op">=</span> <span class="st">"ucb"</span>, kappa <span class="op">=</span> <span class="fl">2.576</span>, eps <span class="op">=</span> <span class="fl">0.0</span>,</span>
<span>                                verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; elapsed = 23.87  Round = 1   horizon = 20.0000   discount = 0.960533 Value = -289.4258 </span></span>
<span><span class="co">#&gt; elapsed = 25.355 Round = 2   horizon = 22.0000   discount = 0.9739558    Value = -287.4896 </span></span>
<span><span class="co">#&gt; elapsed = 29.062 Round = 3   horizon = 26.0000   discount = 0.8916314    Value = -300.3452 </span></span>
<span><span class="co">#&gt; elapsed = 35.395 Round = 4   horizon = 33.0000   discount = 0.8824431    Value = -340.5870 </span></span>
<span><span class="co">#&gt; elapsed = 21.499 Round = 5   horizon = 18.0000   discount = 0.717918 Value = -309.5872 </span></span>
<span><span class="co">#&gt; elapsed = 17.814 Round = 6   horizon = 14.0000   discount = 0.9900   Value = -388.0072 </span></span>
<span><span class="co">#&gt; elapsed = 24.354 Round = 7   horizon = 21.0000   discount = 0.7019426    Value = -288.4061 </span></span>
<span><span class="co">#&gt; elapsed = 24.649 Round = 8   horizon = 21.0000   discount = 0.9900   Value = -289.2448 </span></span>
<span><span class="co">#&gt; elapsed = 31.862 Round = 9   horizon = 29.0000   discount = 0.7050185    Value = -319.2199 </span></span>
<span><span class="co">#&gt; elapsed = 27.18  Round = 10  horizon = 24.0000   discount = 0.7311516    Value = -291.2297 </span></span>
<span><span class="co">#&gt; elapsed = 37.14  Round = 11  horizon = 35.0000   discount = 0.7000   Value = -349.5131 </span></span>
<span><span class="co">#&gt; elapsed = 25.203 Round = 12  horizon = 22.0000   discount = 0.8379493    Value = -290.3592 </span></span>
<span><span class="co">#&gt; elapsed = 27.218 Round = 13  horizon = 24.0000   discount = 0.9900   Value = -288.6685 </span></span>
<span><span class="co">#&gt; elapsed = 25.40  Round = 14  horizon = 22.0000   discount = 0.7987672    Value = -286.1254 </span></span>
<span><span class="co">#&gt; elapsed = 25.31  Round = 15  horizon = 22.0000   discount = 0.8193503    Value = -288.8146 </span></span>
<span><span class="co">#&gt; elapsed = 25.416 Round = 16  horizon = 22.0000   discount = 0.9043957    Value = -284.1406 </span></span>
<span><span class="co">#&gt; elapsed = 25.211 Round = 17  horizon = 22.0000   discount = 0.9900   Value = -289.6519 </span></span>
<span><span class="co">#&gt; elapsed = 25.35  Round = 18  horizon = 22.0000   discount = 0.9877141    Value = -292.0235 </span></span>
<span><span class="co">#&gt; elapsed = 25.32  Round = 19  horizon = 22.0000   discount = 0.7002133    Value = -283.5007 </span></span>
<span><span class="co">#&gt; elapsed = 25.604 Round = 20  horizon = 22.0000   discount = 0.936678 Value = -283.4220 </span></span>
<span><span class="co">#&gt; elapsed = 25.331 Round = 21  horizon = 22.0000   discount = 0.8680492    Value = -282.9043 </span></span>
<span><span class="co">#&gt; elapsed = 25.283 Round = 22  horizon = 22.0000   discount = 0.9176258    Value = -290.0770 </span></span>
<span><span class="co">#&gt; elapsed = 25.419 Round = 23  horizon = 22.0000   discount = 0.7225638    Value = -284.3034 </span></span>
<span><span class="co">#&gt; elapsed = 25.387 Round = 24  horizon = 22.0000   discount = 0.8049441    Value = -286.8484 </span></span>
<span><span class="co">#&gt; elapsed = 25.724 Round = 25  horizon = 22.0000   discount = 0.8184396    Value = -293.2562 </span></span>
<span><span class="co">#&gt; elapsed = 25.429 Round = 26  horizon = 22.0000   discount = 0.7796007    Value = -288.4966 </span></span>
<span><span class="co">#&gt; elapsed = 25.412 Round = 27  horizon = 22.0000   discount = 0.9867218    Value = -287.4619 </span></span>
<span><span class="co">#&gt; elapsed = 25.792 Round = 28  horizon = 22.0000   discount = 0.8082374    Value = -293.9573 </span></span>
<span><span class="co">#&gt; elapsed = 24.612 Round = 29  horizon = 22.0000   discount = 0.9673567    Value = -287.8284 </span></span>
<span><span class="co">#&gt; elapsed = 24.457 Round = 30  horizon = 22.0000   discount = 0.8244174    Value = -293.3437 </span></span>
<span><span class="co">#&gt; elapsed = 25.073 Round = 31  horizon = 22.0000   discount = 0.822453 Value = -286.4732 </span></span>
<span><span class="co">#&gt; elapsed = 24.584 Round = 32  horizon = 22.0000   discount = 0.807405 Value = -291.9611 </span></span>
<span><span class="co">#&gt; elapsed = 24.602 Round = 33  horizon = 22.0000   discount = 0.8030033    Value = -288.3032 </span></span>
<span><span class="co">#&gt; elapsed = 24.416 Round = 34  horizon = 22.0000   discount = 0.9433525    Value = -287.4136 </span></span>
<span><span class="co">#&gt; elapsed = 24.37  Round = 35  horizon = 22.0000   discount = 0.8788171    Value = -286.3122 </span></span>
<span><span class="co">#&gt; elapsed = 24.554 Round = 36  horizon = 22.0000   discount = 0.7216836    Value = -280.9382 </span></span>
<span><span class="co">#&gt; elapsed = 25.301 Round = 37  horizon = 22.0000   discount = 0.820933 Value = -286.8981 </span></span>
<span><span class="co">#&gt; elapsed = 24.375 Round = 38  horizon = 22.0000   discount = 0.7719652    Value = -286.5913 </span></span>
<span><span class="co">#&gt; elapsed = 25.228 Round = 39  horizon = 23.0000   discount = 0.8461284    Value = -288.7408 </span></span>
<span><span class="co">#&gt; elapsed = 24.361 Round = 40  horizon = 22.0000   discount = 0.8523414    Value = -284.3208 </span></span>
<span><span class="co">#&gt; elapsed = 25.47  Round = 41  horizon = 23.0000   discount = 0.8599376    Value = -297.1514 </span></span>
<span><span class="co">#&gt; elapsed = 24.378 Round = 42  horizon = 22.0000   discount = 0.7322901    Value = -288.6720 </span></span>
<span><span class="co">#&gt; elapsed = 24.37  Round = 43  horizon = 22.0000   discount = 0.9155627    Value = -289.7268 </span></span>
<span><span class="co">#&gt; elapsed = 25.333 Round = 44  horizon = 23.0000   discount = 0.917052 Value = -287.8831 </span></span>
<span><span class="co">#&gt; elapsed = 24.62  Round = 45  horizon = 22.0000   discount = 0.7435753    Value = -286.6034 </span></span>
<span><span class="co">#&gt; elapsed = 24.40  Round = 46  horizon = 22.0000   discount = 0.8740574    Value = -291.6472 </span></span>
<span><span class="co">#&gt; elapsed = 24.283 Round = 47  horizon = 22.0000   discount = 0.7216342    Value = -289.3812 </span></span>
<span><span class="co">#&gt; elapsed = 24.351 Round = 48  horizon = 22.0000   discount = 0.8588292    Value = -285.1840 </span></span>
<span><span class="co">#&gt; elapsed = 24.355 Round = 49  horizon = 22.0000   discount = 0.7361584    Value = -290.5996 </span></span>
<span><span class="co">#&gt; elapsed = 24.355 Round = 50  horizon = 22.0000   discount = 0.9419847    Value = -288.9793 </span></span>
<span><span class="co">#&gt; elapsed = 24.428 Round = 51  horizon = 22.0000   discount = 0.9177382    Value = -286.3025 </span></span>
<span><span class="co">#&gt; elapsed = 24.414 Round = 52  horizon = 22.0000   discount = 0.8275065    Value = -290.7872 </span></span>
<span><span class="co">#&gt; elapsed = 24.396 Round = 53  horizon = 22.0000   discount = 0.8798144    Value = -295.7979 </span></span>
<span><span class="co">#&gt; elapsed = 24.368 Round = 54  horizon = 22.0000   discount = 0.8451556    Value = -291.9907 </span></span>
<span><span class="co">#&gt; elapsed = 24.459 Round = 55  horizon = 22.0000   discount = 0.8505539    Value = -288.3171 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Best Parameters Found: </span></span>
<span><span class="co">#&gt; Round = 36   horizon = 22.0000   discount = 0.7216836    Value = -280.9382</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="run-simulations-with-the-optimal-parameters">Run simulations with the optimal parameters<a class="anchor" aria-label="anchor" href="#run-simulations-with-the-optimal-parameters"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">sim_settings</span><span class="op">$</span><span class="va">pred_days</span> <span class="op">&lt;-</span> <span class="va">OPT_Res</span><span class="op">$</span><span class="va">Best_Par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">sim_settings</span><span class="op">$</span><span class="va">gamma</span> <span class="op">&lt;-</span> <span class="va">OPT_Res</span><span class="op">$</span><span class="va">Best_Par</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span><span class="va">episettings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  sim_function <span class="op">=</span> <span class="va">Epi_MPC_run_wd</span>,</span>
<span>  reward_function <span class="op">=</span> <span class="va">reward_fun_wd</span>,</span>
<span>  R_estimator <span class="op">=</span> <span class="va">R_estim</span>,</span>
<span>  noise_par <span class="op">=</span> <span class="va">Noise_pars</span>,</span>
<span>  epi_par <span class="op">=</span> <span class="va">Epi_pars</span>,</span>
<span>  actions <span class="op">=</span> <span class="va">Action_space</span>,</span>
<span>  sim_settings <span class="op">=</span> <span class="va">sim_settings</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">results_opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epicontrol.html">epicontrol</a></span><span class="op">(</span><span class="va">episim_data_ens</span>, <span class="va">episettings</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt;   |                                                          |                                                  |   0%  |                                                          |=====                                             |  10%  |                                                          |==========                                        |  20%  |                                                          |===============                                   |  30%  |                                                          |====================                              |  40%  |                                                          |=========================                         |  50%  |                                                          |==============================                    |  60%  |                                                          |===================================               |  70%  |                                                          |========================================          |  80%  |                                                          |=============================================     |  90%  |                                                          |==================================================| 100%</span></span>
<span>  </span>
<span><span class="va">episim_data_ens</span> <span class="op">&lt;-</span> <span class="va">results_opt</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#for (jj in 1:sim_ens) {</span></span>
<span><span class="co">#  episim_data_ens[[jj]] &lt;- Epi_MPC_run_wd(episim_data_ens[[jj]], Epi_pars, Noise_pars, Action_space, pred_days = pred_days, n_ens = n_ens, ndays = nrow(episim_data), R_est_wind = R_est_wind, pathogen = 1, susceptibles = 0, delay = 0, ur = 0, r_dir = 2, N = N)</span></span>
<span><span class="co">#  setTxtProgressBar(pb,jj)</span></span>
<span><span class="co">#}</span></span>
<span><span class="co">#close(pb)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">jj</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">sim_settings</span><span class="op">$</span><span class="va">sim_ens</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">episim_data_ens</span><span class="op">[[</span><span class="va">jj</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">episim_data_ens</span><span class="op">[[</span><span class="va">jj</span><span class="op">]</span><span class="op">]</span>, <span class="op">-</span><span class="va">sim_settings</span><span class="op">$</span><span class="va">pred_days</span><span class="op">)</span></span>
<span>  <span class="va">episim_data_ens</span><span class="op">[[</span><span class="va">jj</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="st">"D_roll"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html" class="external-link">rollsum</a></span><span class="op">(</span><span class="va">episim_data_ens</span><span class="op">[[</span><span class="va">jj</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="st">"Deaths"</span><span class="op">]</span>, <span class="fl">7</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span>  <span class="va">episim_data_ens</span><span class="op">[[</span><span class="va">jj</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="st">"I_roll"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html" class="external-link">rollsum</a></span><span class="op">(</span><span class="va">episim_data_ens</span><span class="op">[[</span><span class="va">jj</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="st">"I"</span><span class="op">]</span>, <span class="fl">7</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span>  <span class="va">episim_data_ens</span><span class="op">[[</span><span class="va">jj</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="st">"D_cum"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">episim_data_ens</span><span class="op">[[</span><span class="va">jj</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="st">"Deaths"</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">episim_data_ens</span><span class="op">[[</span><span class="va">jj</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="st">"I_cum"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">episim_data_ens</span><span class="op">[[</span><span class="va">jj</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="st">"I"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Combine Simulation Results</span></span>
<span><span class="va">combined_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">episim_data_ens</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="plotting-results">Plotting results<a class="anchor" aria-label="anchor" href="#plotting-results"></a>
</h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">combined_data</span> <span class="op">&lt;-</span> <span class="va">combined_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">sim_id</span>, <span class="va">policy</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">days</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">days</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combined_data</span> <span class="op">&lt;-</span> <span class="va">combined_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">sim_id</span>, <span class="va">days</span>, <span class="va">policy</span><span class="op">)</span></span>
<span></span>
<span><span class="va">policy_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1"</span> <span class="op">=</span> <span class="st">"No intervention"</span>, <span class="st">"2"</span> <span class="op">=</span> <span class="st">"Lockdown"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">combined_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sim_id</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">combined_data</span>, <span class="va">sim_id</span> <span class="op">!=</span> <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">days</span>, y <span class="op">=</span> <span class="va">C</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">sim_id</span><span class="op">)</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">days</span>, y <span class="op">=</span> <span class="va">C</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">policy</span>, labels <span class="op">=</span> <span class="va">policy_labels</span><span class="op">)</span>, group <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">1.0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">days</span>, y <span class="op">=</span> <span class="va">C</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">policy</span>, labels <span class="op">=</span> <span class="va">policy_labels</span><span class="op">)</span>, group <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">1.0</span>, linewidth<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">C_target</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Days"</span>, y <span class="op">=</span> <span class="st">"Reported cases (rolling weekly"</span>, color <span class="op">=</span> <span class="st">"Policy"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"No intervention"</span> <span class="op">=</span> <span class="st">"chartreuse3"</span>, <span class="st">"Lockdown"</span> <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Policy"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="hyperparameter_opt_files/figure-html/plot%20results-1.png" width="700"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sandor Beregi.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
