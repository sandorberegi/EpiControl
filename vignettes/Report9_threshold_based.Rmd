---
title: "Report9_threshold_based"
output: rmarkdown::html_vignette
author: "Sandor Beregi"
date: "`r Sys.Date()`"
vignette: >
  %\VignetteIndexEntry{Report9_threshold_based}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r echo=FALSE, results='asis'}
cat("## Overview\n\n",
    "This vignette demonstrates threshold-based control of ICU cases for COVID-19 \n\n")
```

### Load Libraries and Setup

Load the required libraries and initialize the simulation environment.

```{r load-libraries}
library(EpiControl)
library(VGAM)
library(parallel)
library(pbapply)
library(zoo)  # For rolling sum operations
library(dplyr)
library(ggplot2)
```

Initialize the cluster for parallel computing:

```{r parallel-setup}
cores <- detectCores() - 1
cl <- makeCluster(cores)
```

### Epidemiological and Noise Parameters

Define parameters for pathogens and noise: Can include different pathogens, in this case we consider COVID-19 and Ebola virus.

```{r define-parameters}
Epi_pars <- data.frame(
  Pathogen = c("COVID-19", "Ebola"),
  R0 = c(2.2, 2.5),
  gen_time = c(6.5, 15.0),
  gen_time_var = c(2.1, 2.1),
  CFR = c(0.0132, 0.5),
  mortality_mean = c(10.0, 10.0),
  mortality_var = c(1.1, 1.1)
)

Noise_pars <- data.frame(
  repd_mean = 10.5,  # Reporting delay mean
  del_disp = 5.0,    # Reporting delay variance
  ur_mean = 0.3,     # Under-reporting mean
  ur_beta_a = 50.0   # Beta distribution alpha for under-reporting
)
```

### Action Space for Policy Interventions

Define non-pharmaceutical interventions: We have 2 actions, introducing a "lockdown" and no interventions.

```{r action-space}
Action_space <- data.frame(
  NPI = c("No restrictions", "Lockdown"),
  R_coeff = c(1.0, 0.3),
  R_beta_a = c(0.0, 5.0),
  cost_of_NPI = c(0.0, 0.15)
)
```

### Simulation Setup

Set up key parameters and initialize simulation data:

```{r simulation-setup}
ndays <- 83 * 7 #simulation length
N <- 1e7 # population size
I0 <- 10 # initial infections

column_names <- c("days", "sim_id", "I", "Lambda", "C", "Lambda_C", "S", "Deaths", "Re", "Rew", "Rest", "R0est", "policy", "R_coeff")
episim_data <- data.frame(matrix(0, nrow = ndays, ncol = length(column_names)))
colnames(episim_data) <- column_names

episim_data$policy <- rep(1, ndays)
episim_data$days <- 1:ndays
episim_data[1, ] <- c(1, 1, I0, I0, Noise_pars$ur_mean * I0, Noise_pars$ur_mean * I0, N - I0, 0, Epi_pars[1, "R0"], Epi_pars[1, "R0"], 1, 1, 1, 1)
```

### Running the Simulation

Run simulations in parallel using the pblapply function:

```{r run-simulation}
#Set on/off thresholds in daily ICU cases for implementing lockdown.
LD_on <- 14
LD_off <- 7

#Sim and control options
cost_sel <- 1L # : bilinear+oveshoot, 2: flat+quadratic for overshoot, 3: ReLu + Overshoot
use_inc <- 1L #1: control for incidence, 0: control for infectiousness
delay_calc_v <- 0L #1: as in ref, 0: from incidence
under_rep_calc <- 3L #1: as in ref, 0: separately, from incidence, 2: same, but using a beta distribution for rho
distr_sel <- 1L #0: Deterministic, 1: Poisson, 2: Binomial
delay_on <- 1L #1: sim with time-delay, 0: no-delay (if 0, set delay_calc_v = 0)
under_rep_on <- 1L #0: no under reporting, 1: calculate with under-reporting

C_target <- 5000 #target cases
C_target_pen <- C_target*1.5 #overshoot penalty threshold
R_target <- 1.0
D_target <- 12 #one way to get peaks at 400 is to increase this to 15
D_target_pen <- 50 #max death
alpha <- 0*1.3/C_target #~proportional gain (regulates error in cases) covid
#alpha = 3.25/C_target #~proportional gain (regulates error in cases) ebola
#beta <- 0.0 #~derivative gain (regulates error in R)
alpha_d <- 1.3/D_target
ovp <- 0*5.0 #overshoot penalty
dovp <- 10.0 #death overshoot penalty
gamma <- 0.95 #discounting factor

#Simulation parameters
n_ens <- 20L #MC assembly size for 4
sim_ens <- 100L #assembly size for full simulation

#Frequecy of policy review
rf <- 1L #we monitor thresholds every day
R_est_wind <- 5L #rf-2 #window for R estimation
use_S <- 0L

#Prediction window
pred_days <- 28L #12L #14 #21 #12 it was 21 for 14

r_trans_steep <- 1.5  # Growth rate
r_trans_len <- 7  # Number of days for the transition
t0 <- r_trans_len  / 2 # Midpoint of the transition

episim_data_ens <- replicate(sim_ens, episim_data, simplify = FALSE)

for (ii in 1:sim_ens) {
  episim_data_ens[[ii]]$sim_id <- rep(ii, ndays)
}

clusterExport(cl, ls())
clusterExport(cl, c("episim_data_ens", "Epi_pars", "Noise_pars", "Action_space", "logistic_function", "Epi_MPC_run_wd_thr", "ndays"))

results <- pblapply(1:sim_ens, function(jj) {
  episim_data_ens[[jj]] <- Epi_MPC_run_wd_thr(episim_data_ens[[jj]], Epi_pars, Noise_pars, Action_space, pred_days = pred_days, start_day = 1, n_ens = n_ens, ndays = nrow(episim_data), R_est_wind = R_est_wind, pathogen = 1, susceptibles = 0, delay = 0, ur = 0, r_dir = 2, N = N)
}, cl=cl)

episim_data_ens <- results
stopCluster(cl)

#for (jj in 1:sim_ens) {
#  episim_data_ens[[jj]] <- Epi_MPC_run_wd(episim_data_ens[[jj]], Epi_pars, Noise_pars, Action_space, pred_days = pred_days, n_ens = n_ens, ndays = nrow(episim_data), R_est_wind = R_est_wind, pathogen = 1, susceptibles = 0, delay = 0, ur = 0, r_dir = 2, N = N)
#  setTxtProgressBar(pb,jj)
#}
#close(pb)

for (jj in 1:sim_ens) {
  episim_data_ens[[jj]] <- head(episim_data_ens[[jj]], -pred_days)
  episim_data_ens[[jj]]["D_roll"] <- rollsum(episim_data_ens[[jj]]["Deaths"], 7, fill = NA)
  episim_data_ens[[jj]]["I_roll"] <- rollsum(episim_data_ens[[jj]]["I"], 7, fill = NA)
  episim_data_ens[[jj]]["D_cum"] <- cumsum(episim_data_ens[[jj]]["Deaths"])
  episim_data_ens[[jj]]["I_cum"] <- cumsum(episim_data_ens[[jj]]["I"])
}

# Combine Simulation Results
combined_data <- do.call(rbind, episim_data_ens)
```

### Plotting results

```{r plot results}

combined_data <- combined_data %>%
  group_by(sim_id, policy) %>%
  arrange(days) %>%
  mutate(group = cumsum(c(1, diff(days) != 1))) %>%
  ungroup()

combined_data <- combined_data %>%
  arrange(sim_id, days, policy)

policy_labels <- c("1" = "No intervention", "2" = "Lockdown")


# Plotting the data
ggplot(combined_data %>% filter(sim_id == 1)) +
  geom_line(data = subset(combined_data, sim_id != 1), aes(x = days, y = D_roll, color = as.factor(sim_id)), alpha = 0.1) +
  geom_line(aes(x = days, y = D_roll, color = factor(policy, labels = policy_labels), group = 1), alpha = 1.0) +
  geom_line(aes(x = days, y = D_roll, color = factor(policy, labels = policy_labels), group = 1), alpha = 1.0, size=0.25) +
  geom_hline(yintercept = 7*LD_on, linetype = "dashed", color = "blue", size=0.25) +
  geom_hline(yintercept = 7*LD_off, linetype = "dashed", color = "purple", size=0.25) +
  labs(x = "Days", y = "Reported cases (rolling weekly", color = "Policy") +
  scale_color_manual(values = c("No intervention" = "chartreuse3", "Lockdown" = "red")) +
  guides(color = guide_legend(title = "Policy")) +
  scale_y_continuous(
    name = "ICU cases (weekly, rolling)",
    sec.axis = sec_axis(~./100, name = "R")
  ) +
  geom_line(data = subset(combined_data, sim_id == 1), aes(x = days, y = 100*Re), color = "darkred", size=0.25, alpha = 1.0)
```
